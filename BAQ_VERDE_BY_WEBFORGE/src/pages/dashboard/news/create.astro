---
import Layout from '../../../layouts/DashboardLayout.astro';
import { api } from '../../../lib/api';
export const prerender = false;

const cookieStore = Astro.cookies;
const sessionToken = cookieStore.get('token')?.value;

if (!sessionToken) {
  return Astro.redirect('/login');
}

// Borrar la cookie directamente desde el servidor si se pide
if (Astro.url.searchParams.get('logout') === 'true') {
  Astro.cookies.delete('token', { path: '/' });
  return Astro.redirect('/login');
}

let error = null;
let success = null;

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const title = formData.get('title')?.toString();
  const category = formData.get('category')?.toString();
  const content = formData.get('content')?.toString();
  const imageFile = formData.get('image') as File;

  if (!title || !category || !content) {
    error = 'Todos los campos son requeridos';
  } else {
    let img_url = null;

    // Si hay imagen, convertirla a base64
    if (imageFile && imageFile.size > 0) {
      const arrayBuffer = await imageFile.arrayBuffer();
      const base64 = Buffer.from(arrayBuffer).toString('base64');
      const mimeType = imageFile.type;
      img_url = `${base64}`;
    }
    console.log(img_url)

    const res = await api("/news/", sessionToken, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title,
        category,
        content,
        img_url, 
      })
    });

    console.log(res)

    if (res) {
      success = 'Noticia creada con √©xito';
      // Redirigir inmediatamente (no puedes usar setTimeout en server-side)
      return Astro.redirect('/dashboard/noticias');
    } else {
      error = 'Error al crear la noticia';
    }
  }
}
---

<Layout title="Crear Noticia">
  <div class="container">
    <h1>üìù Crear Nueva Noticia</h1>

    {error && <div class="alert error">{error}</div>}
    {success && <div class="alert success">{success}</div>}

    <form method="post" class="form-noticia" enctype="multipart/form-data">
      <div class="form-group">
        <label for="title">T√≠tulo</label>
        <input type="text" id="title" name="title" required />
      </div>

      <div class="form-group">
        <label for="category">Categor√≠a</label>
        <select id="category" name="category" required>
          <option value="">Selecciona una categor√≠a</option>
          <option value="Deportes">Deportes</option>
          <option value="Tecnolog√≠a">Tecnolog√≠a</option>
          <option value="Pol√≠tica">Pol√≠tica</option>
          <option value="Entretenimiento">Entretenimiento</option>
          <option value="Salud">Salud</option>
          <!-- A√±ade m√°s seg√∫n necesites -->
        </select>
      </div>

      <div class="form-group">
        <label for="content">Contenido</label>
        <textarea id="content" name="content" rows="6" required></textarea>
      </div>

      <div class="form-group">
        <label for="image">Imagen</label>
        <input type="file" id="image" name="image" accept="image/*" required />
      </div>

      <button type="submit" class="btn-submit">üíæ Guardar Noticia</button>
      <a href="/dashboard/noticias" class="btn-cancel">‚¨ÖÔ∏è Cancelar</a>
    </form>
  </div>

  <style>
    .container { padding: 20px; max-width: 800px; margin: 0 auto; }
    .form-noticia { display: flex; flex-direction: column; gap: 20px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .form-group input[type="file"] {
      color: white;
      background: transparent;
    }
    .btn-submit {
      padding: 12px 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-cancel {
      padding: 10px 20px;
      background: #666;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      text-align: center;
      display: inline-block;
    }
    .alert {
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .alert.error { background: #f44336; color: white; }
    .alert.success { background: #4CAF50; color: white; }
  </style>
</Layout>